<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ‹œè€³æ³•ç”Ÿäº§æ°§åŒ–é“ç›‘æ§åˆ†æç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="dashboard">
    <div class="background-grid"></div>
    <header class="dashboard-header">
        <div class="title-block">
            <h1>æ‹œè€³æ³•ç”Ÿäº§æ°§åŒ–é“ç›‘æ§åˆ†æç³»ç»Ÿ</h1>
            <p>æ‹œè€³æ³•ç”Ÿäº§æ•°æ®ç¦»çº¿ç›‘æµ‹ä¸é¢„æµ‹å¹³å°</p>
        </div>
        <div class="header-controls">
            <div class="status-bar" id="provider-status-bar">
                <span class="status-item" data-provider="tablegpt">TableGPT</span>
                <span class="status-item" data-provider="ollama">Ollama</span>
                <span class="status-item" data-provider="bailian">ç™¾ç‚¼</span>
            </div>
            <form id="preview-form" class="control-form">
                <label for="file" class="control-label">ä¸Šä¼ å†å²æ•°æ® (CSV / Excel)</label>
                <div class="control-inputs">
                    <input type="file" id="file" name="file" accept=".csv,.xls,.xlsx" required>
                    <button type="submit">é¢„è§ˆæ•°æ®</button>
                </div>
            </form>
            <div class="toolbar-actions">
                <button type="button" id="open-balance" class="balance-button">å¹³è¡¡è®¡ç®—</button>
                <button type="button" id="open-ai-chat" class="ai-entry-button">AI é—®ç­”</button>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <aside class="sidebar">
            <section class="panel-block">
                <h2>é¢„è­¦ä¿¡æ¯</h2>
                <div id="warning-messages" class="warning-list">æš‚æ— é¢„è­¦</div>
            </section>
            <section class="panel-block">
                <h2>æ•°æ®æ¦‚è§ˆ</h2>
                <div id="preview-info" class="preview-info">è¯·ä¸Šä¼ æ•°æ®ä»¥é¢„è§ˆå­—æ®µã€‚</div>
            </section>
            <section class="panel-block">
                <h2>è¡¨æ ¼ä¿¡æ¯å¯¹è¯</h2>
                <div class="table-chat-preview">
                    <p id="table-chat-status">è¯·å…ˆä¸Šä¼ æ•°æ®å¹¶å®Œæˆé¢„è§ˆã€‚</p>
                    <button type="button" id="open-table-chat" class="ghost" disabled>æ‰“å¼€å¯¹è¯</button>
                </div>
            </section>
        </aside>

        <section class="main-content">
            <div class="panel-grid">
                <div class="panel-block selection-panel">
                    <h2>æŒ‡æ ‡é€‰æ‹©</h2>
                    <form id="analysis-form" class="hidden selection-form">
                        <div class="selection-top">
                            <div class="field-select keyword">
                                <label for="column-search">å…³é”®è¯</label>
                                <input type="text" id="column-search" placeholder="è¾“å…¥å…³é”®è¯è¿‡æ»¤å­—æ®µ...">
                            </div>
                            <div class="field-select timestamp">
                                <label for="timestamp">æ—¶é—´å­—æ®µ</label>
                                <select id="timestamp" name="timestamp"></select>
                            </div>
                        </div>
                        <div class="selection-list" id="columns-container">
                            <select id="columns" name="columns" multiple size="12"></select>
                        </div>
                        <div class="selection-actions">
                            <div class="hint">å¯å¤šé€‰ï¼Œé»˜è®¤å‹¾é€‰ç³»ç»Ÿæ¨èå­—æ®µã€‚</div>
                            <div class="buttons">
                                <button type="button" id="select-all" class="ghost">å…¨é€‰</button>
                                <button type="button" id="clear-all" class="ghost">æ¸…é™¤</button>
                                <button type="submit" class="primary">å¼€å§‹åˆ†æ</button>
                                <button type="button" id="open-report" class="ghost" disabled>ç”ŸæˆæŠ¥è¡¨</button>
                                <button type="button" id="export-excel" class="ghost" disabled>å¯¼å‡ºExcel</button>
                                <button type="button" id="open-parameter-analysis" class="ghost" disabled>å‚æ•°å½±å“åˆ†æ</button>
                                <button type="button" id="open-model-lab" class="ghost" disabled>é¢„æµ‹æ¨¡å‹å®éªŒ</button>
                                <button type="button" id="open-kg-graph" class="ghost" disabled>çŸ¥è¯†å›¾è°±å®éªŒ</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="panel-block">
                    <h2>è¶‹åŠ¿åˆ†æ</h2>
                    <div id="forecast-chart" class="forecast-chart">
                        <p class="empty-state">ç­‰å¾…åˆ†æç»“æœ...</p>
                    </div>
                    <div id="forecast-legend" class="chart-legend"></div>
                </div>

                <div class="panel-block">
                    <h2>æŒ‡æ ‡è¯Šæ–­è¯¦æƒ…</h2>
                    <div id="analysis-report" class="detail-grid">
                        <p class="empty-state">ç­‰å¾…åˆ†æç»“æœ...</p>
                    </div>
                </div>
            </div>
        </section>

        <aside class="sidebar">
            <section class="panel-block">
                <h2>ç»Ÿè®¡åˆ†æ</h2>
                <div id="stat-chart" class="chart-placeholder">ç­‰å¾…åˆ†æç»“æœ...</div>
            </section>
            <section class="panel-block">
                <h2>é£é™©è¶‹åŠ¿æ‘˜è¦</h2>
                <div id="risk-trend" class="chart-placeholder">--</div>
            </section>
            <section class="panel-block">
                <h2>é£é™©æºæ€åŠ¿</h2>
                <div id="risk-source" class="chart-placeholder">--</div>
            </section>
        </aside>
    </main>

    <div id="ai-modal" class="ai-modal hidden">
        <div class="ai-modal-content">
            <header>
                <h2>AI é—®ç­”åŠ©æ‰‹</h2>
                <button type="button" id="close-ai-modal" class="close-btn">Ã—</button>
            </header>
            <main>
                <div class="ai-panel">
                    <form id="ai-form">
                        <div class="ai-controls">
                            <select id="ai-provider">
                                <option value="bailian">ç™¾ç‚¼æ™ºèƒ½ä½“</option>
                                <option value="baidu">ç™¾åº¦AI</option>
                            </select>
                        </div>
                        <textarea id="ai-question" placeholder="è¯·è¾“å…¥è¦å’¨è¯¢çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šå½“å‰æŒ‡æ ‡å¼‚å¸¸å¯èƒ½çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ" required></textarea>
                        <label class="skip-validation">
                            <input type="checkbox" id="ai-skip-validation">
                            è·³è¿‡å·¥åºæ£€æµ‹ï¼ˆä»…åœ¨ç¡®è®¤æ— åŒ¹é…å­—æ®µæ—¶ä½¿ç”¨ï¼‰
                        </label>
                        <div class="ai-modal-actions">
                            <button type="button" id="ai-send">å‘é€</button>
                        </div>
                    </form>
                    <div id="ai-response" class="ai-response empty-state">æ¬¢è¿æé—®ï¼Œæˆ‘å¯ä»¥æä¾›æ‹œè€³æ³•ç”Ÿäº§ç›¸å…³åˆ†æå»ºè®®ã€‚</div>
                    <div id="ai-quota-info" class="ai-quota-info"></div>
                </div>
            </main>
        </div>
        <div class="ai-modal-backdrop"></div>
    </div>

    <div id="balance-modal" class="balance-modal hidden">
        <div class="balance-modal-content">
            <header>
                <h2>æ‹œè€³æ³•ç”Ÿäº§å¹³è¡¡è®¡ç®—</h2>
                <button type="button" id="close-balance-modal" class="close-btn">Ã—</button>
            </header>
            <main>
                <div class="balance-content">
                    <section class="balance-input-panel">
                        <h3>è¾“å…¥å‚æ•°</h3>
                        <div class="balance-status" id="balance-status">é»˜è®¤ä½¿ç”¨é¢„è®¾å‚æ•°ï¼Œå¯è‡ªè¡Œè°ƒæ•´ã€‚</div>
                        <div class="balance-table-wrapper">
                            <table class="balance-input-table">
                                <thead>
                                    <tr>
                                        <th>ææ–™</th>
                                        <th>Alâ‚‚Oâ‚ƒ %</th>
                                        <th>SiOâ‚‚ %</th>
                                        <th>Feâ‚‚Oâ‚ƒ %</th>
                                        <th>TiOâ‚‚ %</th>
                                        <th>CaO %</th>
                                        <th>Hâ‚‚O %</th>
                                        <th>COâ‚‚ %</th>
                                        <th>Naâ‚‚O %</th>
                                        <th>å…¶ä»– %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>é“åœŸçŸ¿</td>
                                        <td><input type="number" step="0.01" data-mineral="bauxite" data-index="0" value="50"></td>
                                        <td><input type="number" step="0.01" data-mineral="bauxite" data-index="1" value="8"></td>
                                        <td><input type="number" step="0.01" data-mineral="bauxite" data-index="2" value="20"></td>
                                        <td><input type="number" step="0.01" data-mineral="bauxite" data-index="3" value="3.76"></td>
                                        <td><input type="number" step="0.01" data-mineral="bauxite" data-index="4" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="bauxite" data-index="5" value="5"></td>
                                        <td><input type="number" step="0.01" data-mineral="bauxite" data-index="6" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="bauxite" data-index="7" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="bauxite" data-index="8" value="13.24"></td>
                                    </tr>
                                    <tr>
                                        <td>çŸ³ç°</td>
                                        <td><input type="number" step="0.01" data-mineral="lime" data-index="0" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="lime" data-index="1" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="lime" data-index="2" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="lime" data-index="3" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="lime" data-index="4" value="85"></td>
                                        <td><input type="number" step="0.01" data-mineral="lime" data-index="5" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="lime" data-index="6" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="lime" data-index="7" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="lime" data-index="8" value="15"></td>
                                    </tr>
                                    <tr>
                                        <td>æˆå“æ°§åŒ–é“</td>
                                        <td><input type="number" step="0.01" data-mineral="alumina" data-index="0" value="99"></td>
                                        <td><input type="number" step="0.01" data-mineral="alumina" data-index="1" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="alumina" data-index="2" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="alumina" data-index="3" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="alumina" data-index="4" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="alumina" data-index="5" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="alumina" data-index="6" value="0"></td>
                                        <td><input type="number" step="0.01" data-mineral="alumina" data-index="7" value="1"></td>
                                        <td><input type="number" step="0.01" data-mineral="alumina" data-index="8" value="0"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h3>å·¥è‰ºå‚æ•°</h3>
                        <div class="balance-param-grid" id="balance-param-grid"></div>

                        <div class="balance-actions">
                            <button type="button" id="reset-balance" class="ghost">æ¢å¤é»˜è®¤</button>
                            <button type="button" id="submit-balance" class="primary">ğŸ§® å¼€å§‹è®¡ç®—</button>
                        </div>
                    </section>
                    <section class="balance-result-panel">
                        <h3>è®¡ç®—ç»“æœ</h3>
                        <div id="balance-result" class="balance-result">
                            <p class="loading-text">è¯·ç‚¹å‡»"å¼€å§‹è®¡ç®—"ä»¥ç”Ÿæˆå¹³è¡¡ç»“æœã€‚</p>
                        </div>
                    </section>
                </div>
            </main>
        </div>
        <div class="balance-modal-backdrop"></div>
    </div>

    <div id="table-chat-modal" class="table-chat-modal hidden">
        <div class="table-chat-content">
            <header>
                <h2>è¡¨æ ¼ä¿¡æ¯å¯¹è¯</h2>
                <button type="button" id="close-table-chat" class="close-btn">Ã—</button>
            </header>
            <main>
                <div class="table-chat-panel">
                    <div class="table-chat-controls">
                        <select id="table-chat-provider" data-tablegpt-base="{{ settings.tablegpt_base_url or '' }}">
                            <option value="bailian">ç™¾ç‚¼æ¨¡å‹</option>
                            <option value="tablegpt">TableGPTï¼ˆæœ¬åœ°ï¼‰</option>
                            <option value="ollama">Ollamaï¼ˆæœ¬åœ°ï¼‰</option>
                        </select>
                    </div>
                    <textarea id="table-chat-question" placeholder="è¯·è¾“å…¥éœ€è¦åˆ†æçš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæœ€è¿‘ä¸‰å¤©çš„å…³é”®æŒ‡æ ‡è¶‹åŠ¿å¦‚ä½•ï¼Ÿ" required></textarea>
                    <div class="table-chat-actions">
                        <label class="skip-validation">
                            <input type="checkbox" id="table-chat-skip-validation">
                            è·³è¿‡å·¥åºæ£€æµ‹ï¼ˆä»…åœ¨ç¡®è®¤æ— åŒ¹é…å­—æ®µæ—¶ä½¿ç”¨ï¼‰
                        </label>
                        <button type="button" id="table-chat-send">åˆ†æ</button>
                    </div>
                    <div id="table-chat-response" class="table-chat-response empty-state">å‡†å¤‡å°±ç»ªï¼Œè¯·è¾“å…¥é—®é¢˜åç‚¹å‡»"åˆ†æ"ã€‚</div>
                    <div id="table-chat-quota" class="table-chat-quota-info"></div>
                </div>
            </main>
        </div>
        <div class="table-chat-backdrop"></div>
    </div>

    <div id="report-modal" class="report-modal hidden">
        <div class="report-modal-content">
            <header>
                <h2>æŒ‡æ ‡åˆ†ææŠ¥è¡¨</h2>
                <div class="report-header-actions">
                    <button type="button" id="report-export" class="ghost" disabled>å¯¼å‡º</button>
                    <button type="button" id="close-report-modal" class="close-btn">Ã—</button>
                </div>
            </header>
            <main>
                <div class="report-meta">
                    <p><strong>é€‰æ‹©å­—æ®µï¼š</strong><span id="report-columns">--</span></p>
                    <p><strong>æ—¶é—´å­—æ®µï¼š</strong><span id="report-timestamp">--</span></p>
                </div>
                <textarea id="report-editor"></textarea>
                <div id="report-message" class="report-message empty-state">è¯·ç”ŸæˆæŠ¥è¡¨åæŸ¥çœ‹ã€‚</div>
            </main>
        </div>
        <div class="report-modal-backdrop"></div>
    </div>

    <script>
        const previewForm = document.getElementById('preview-form');
        const analysisForm = document.getElementById('analysis-form');
        const warningList = document.getElementById('warning-messages');
        const previewDiv = document.getElementById('preview-info');
        const statChartDiv = document.getElementById('stat-chart');
        const riskTrendDiv = document.getElementById('risk-trend');
        const riskSourceDiv = document.getElementById('risk-source');
        const resultDiv = document.getElementById('analysis-report');
        const forecastChartDiv = document.getElementById('forecast-chart');
        const forecastLegend = document.getElementById('forecast-legend');
        const columnsSelect = document.getElementById('columns');
        const columnSearch = document.getElementById('column-search');
        const timestampSelect = document.getElementById('timestamp');
        const selectAllBtn = document.getElementById('select-all');
        const clearAllBtn = document.getElementById('clear-all');
        const openReportBtn = document.getElementById('open-report');
        const exportExcelBtn = document.getElementById('export-excel');
        const openParameterAnalysisBtn = document.getElementById('open-parameter-analysis');
        const openModelLabBtn = document.getElementById('open-model-lab');
        const openKgGraphBtn = document.getElementById('open-kg-graph');
        const aiQuestionInput = document.getElementById('ai-question');
        const aiProviderSelect = document.getElementById('ai-provider');
        const aiResponseDiv = document.getElementById('ai-response');
        const aiSendBtn = document.getElementById('ai-send');
        const aiModal = document.getElementById('ai-modal');
        const openAiBtn = document.getElementById('open-ai-chat');
        const closeAiBtn = document.getElementById('close-ai-modal');
        const aiQuotaInfo = document.getElementById('ai-quota-info');
        const openTableChatBtn = document.getElementById('open-table-chat');
        const tableChatStatus = document.getElementById('table-chat-status');
        const tableChatModal = document.getElementById('table-chat-modal');
        const closeTableChatBtn = document.getElementById('close-table-chat');
        const tableChatQuestion = document.getElementById('table-chat-question');
        const tableChatSendBtn = document.getElementById('table-chat-send');
        const tableChatResponse = document.getElementById('table-chat-response');
        const tableChatQuotaInfo = document.getElementById('table-chat-quota');
        const tableChatProviderSelect = document.getElementById('table-chat-provider');
        const aiSkipValidation = document.getElementById('ai-skip-validation');
        const tableChatSkipValidation = document.getElementById('table-chat-skip-validation');
        async function initTablegptBase() {
            const fallback = tableChatProviderSelect.getAttribute('data-tablegpt-base') || '';
            try {
                const resp = await fetch('/config/tablegpt');
                const data = await resp.json();
                const baseUrl = data?.base_url || fallback;
                tableChatProviderSelect.dataset.tablegptBase = baseUrl;
                tableChatProviderSelect.setAttribute('data-tablegpt-base', baseUrl);
                if (baseUrl) {
                    localStorage.setItem('tablegpt_base_url', baseUrl);
                    sessionStorage.setItem('tablegpt_base_url', baseUrl);
                }
            } catch (err) {
                console.warn('è·å– TableGPT é…ç½®å¤±è´¥:', err);
                tableChatProviderSelect.dataset.tablegptBase = fallback;
            }
        }
        initTablegptBase();
        const palette = ['#4fc3f7', '#64ffda', '#ff8a80', '#ffd54f', '#ba68c8', '#4dd0e1'];
        const balanceModal = document.getElementById('balance-modal');
        const openBalanceBtn = document.getElementById('open-balance');
        const closeBalanceBtn = document.getElementById('close-balance-modal');
        const balanceResultDiv = document.getElementById('balance-result');
        const balanceParamGrid = document.getElementById('balance-param-grid');
        const submitBalanceBtn = document.getElementById('submit-balance');
        const resetBalanceBtn = document.getElementById('reset-balance');
        const balanceStatusDiv = document.getElementById('balance-status');

        const reportModal = document.getElementById('report-modal');
        const reportEditor = document.getElementById('report-editor');
        const reportColumnsSpan = document.getElementById('report-columns');
        const reportTimestampSpan = document.getElementById('report-timestamp');
        const reportMessage = document.getElementById('report-message');
        const closeReportBtn = document.getElementById('close-report-modal');
        const reportExportBtn = document.getElementById('report-export');
        const tableChatFocusSelect = document.getElementById('table-chat-focus');

        let cachedFile = null;
        let numericColumnsCache = [];
        let suggestedColumns = [];
        let selectedColumns = [];
        let tableCacheKey = '';
        let allColumnsCache = [];

        const PROCESS_KEYWORDS = [
            { name: 'æº¶å‡º', aliases: ['æº¶å‡º', 'æº¶è§£', 'dissolution'] },
            { name: 'æ²‰é™', aliases: ['æ²‰é™', 'æ²‰æ·€', 'setté™', 'settling'] },
            { name: 'ç……çƒ§', aliases: ['ç……çƒ§', 'ç„™çƒ§', 'calcine', 'calcining'] },
            { name: 'ç„™çƒ§', aliases: ['ç„™çƒ§', 'roast'] },
            { name: 'è¿‡æ»¤', aliases: ['è¿‡æ»¤', 'filter'] },
            { name: 'åˆ†è§£', aliases: ['åˆ†è§£', 'decomposition', 'ç²¾æ¶²', 'å¹³ç›˜', 'ç«‹ç›˜', 'åˆ†çº§æœº'] },
            { name: 'è’¸å‘', aliases: ['è’¸å‘', 'evaporation', 'è’¸å‘å™¨', 'ç¢±', 'æ’ç›', 'é—ªè’¸', 'å¼ºåˆ¶æ•ˆ'] },
            { name: 'è‹›åŒ–', aliases: ['è‹›åŒ–', 'caustic', 'causticization'] },
            { name: 'æ´—æ¶¤', aliases: ['æ´—æ¶¤', 'æ´—æ¶²', 'washing', 'ä¸€æ´—', 'äºŒæ´—', 'ä¸‰æ´—', 'å››æ´—', 'èµ¤æ³¥'] },
            { name: 'åŸçŸ¿æµ†', aliases: ['åŸçŸ¿æµ†', 'åŸæ–™åˆ¶å¤‡', 'æ–™æµ†', 'slurry', 'preparation'] },
            { name: 'é¢„è„±ç¡…', aliases: ['é¢„è„±ç¡…', 'è„±ç¡…', 'desilication'] },
            { name: 'ç¨€é‡Š', aliases: ['ç¨€é‡Š', 'dilution'] },
            { name: 'åˆ†ç¦»', aliases: ['åˆ†ç¦»', 'separation', 'åˆ†ç¦»æœº'] },
            { name: 'å¾ªç¯æ¯æ¶²', aliases: ['å¾ªç¯æ¯æ¶²', 'æ¯æ¶²', 'å¾ªæ¯', 'mother liquor'] },
        ];

        function resolveProcessContext(question) {
            const trimmed = (question || '').trim();
            if (!trimmed) {
                return { success: false, reason: 'empty' };
            }
            const lowerQuestion = trimmed.toLowerCase();
            let matchedProcess = null;
            for (const item of PROCESS_KEYWORDS) {
                if (item.aliases.some((alias) => lowerQuestion.includes(alias.toLowerCase()))) {
                    matchedProcess = item;
                    break;
                }
            }
            if (!matchedProcess) {
                return { success: false, reason: 'missing_keyword' };
            }
            const keywordMatches = matchedProcess.aliases.filter((alias) => lowerQuestion.includes(alias.toLowerCase()));
            const columns = (allColumnsCache || []).filter((col) => {
                const lowerCol = col.toLowerCase();
                return matchedProcess.aliases.some((alias) => lowerCol.includes(alias.toLowerCase()));
            });
            if (!columns.length) {
                return { success: false, reason: 'no_columns', process: matchedProcess.name, matches: keywordMatches };
            }
            const contextColumns = columns.slice(0, 8);
            const enrichedQuestion = `ã€å·¥åºï¼š${matchedProcess.name}ã€‘${keywordMatches.length ? `ã€è¯†åˆ«åˆ°å…³é”®è¯ï¼š${keywordMatches.join('ï¼Œ')}ã€‘` : ''}ã€ç›¸å…³å­—æ®µï¼š${contextColumns.join('ï¼Œ')}ã€‘${trimmed}`;
            return {
                success: true,
                process: matchedProcess.name,
                columns,
                matches: keywordMatches,
                enrichedQuestion,
            };
        }

        const reportState = {
            content: '',
            draft: '',
            columns: [],
            timestampColumn: '',
            generatedAt: '',
        };

        function resetReportState() {
            reportState.content = '';
            reportState.draft = '';
            reportState.columns = [];
            reportState.timestampColumn = '';
            reportState.generatedAt = '';
        }

        openReportBtn.disabled = true;
        resetReportState();

        let processParamMeta = [];
        let currentModelId = '';
        let currentModelType = 'lstm';

        const defaultProcessParams = {
            B6: 180,
            B7: 15,
            B8: 2.835,
            B9: 1.27,
            B10: 340,
            B11: 1.2,
            B12: 2.265,
            B13: 1,
            B14: 0.63,
            B15: 3,
            B16: 145,
            B17: 1.325,
            B18: 1.317,
            B19: 1.355,
            B20: 333,
            B21: 420,
            D6: 550,
            D7: 15,
            D8: 1,
            D9: 5,
            D10: 4,
            D11: 1,
            D12: 15,
            D13: 612,
            D14: 3.5,
            D15: 1,
            D16: 1.2,
            D17: 320,
            D18: 80,
            F6: 51.3,
            F7: 146,
            F8: 19.4,
            F9: 1.268,
            F10: 1.5,
            F11: 1,
            F12: 0.85,
            F13: 1.1,
            F14: 0.9,
            F15: 165,
            F16: 4.7,
            F17: 10,
            F18: 80,
        };

        const defaultProcessParamMeta = {
            B6: { label: 'å¾ªç¯æ¯æ¶²Nk g/l', unit: 'g/L', step: 0.1 },
            B7: { label: 'å¾ªç¯æ¯æ¶²Nc g/l', unit: 'g/L', step: 0.1 },
            B8: { label: 'å¾ªæ¯ Î±k', unit: '', step: 0.001 },
            B9: { label: 'å¾ªæ¯Ï g/cmÂ³', unit: 'g/cmÂ³', step: 0.001 },
            B10: { label: 'è¡¥å……ç¢±æ¶²NK g/l', unit: 'g/L', step: 0.1 },
            B11: { label: 'è¡¥ç¢±Ï g/cmÂ³', unit: 'g/cmÂ³', step: 0.001 },
            B12: { label: 'çŸ³ç°æ·»åŠ é‡ï¼…', unit: '%', step: 0.01 },
            B13: { label: 'èµ¤æ³¥é“ç¡…æ¯”', unit: '', step: 0.01 },
            B14: { label: 'èµ¤æ³¥é’ ç¡…æ¯”', unit: '', step: 0.01 },
            B15: { label: 'èµ¤æ³¥ç¼å‡ï¼ˆç»“æ™¶æ°´ï¼‰%', unit: '%', step: 0.01 },
            B16: { label: 'æº¶å‡ºç¨€é‡ŠNk g/l', unit: 'g/L', step: 0.1 },
            B17: { label: 'æº¶å‡ºç¨€é‡ŠÎ±k', unit: '', step: 0.001 },
            B18: { label: 'æº¶å‡ºÎ±k', unit: '', step: 0.001 },
            B19: { label: 'æº¶å‡ºç¨€é‡ŠÏ g/cmÂ³', unit: 'g/cmÂ³', step: 0.001 },
            B20: { label: 'èµ¤æ³¥åˆ†ç¦»æ²‰é™æ§½åº•æµæ¶²å›ºå«', unit: 'g/L', step: 0.1 },
            B21: { label: 'èµ¤æ³¥æœ«æ¬¡æ´—æ¶¤æ²‰é™æ§½åº•æµå›ºå«', unit: 'g/L', step: 0.1 },
            D6: { label: 'æº¶å‡ºçŸ¿æµ†è‡ªç„¶è’¸å‘æ°´ kg', unit: 'kg', step: 1 },
            D7: { label: 'ç‰©æ–™æ»´æ¼èµ¤æ³¥é™„æ¶²Naâ‚‚OæŸå¤± kg', unit: 'kg', step: 0.1 },
            D8: { label: 'æº¶å‡ºæ°´è§£é“%', unit: '%', step: 0.01 },
            D9: { label: 'å¨å¹²èµ¤æ³¥çš„èµ¤æ³¥é™„æ¶²Naâ‚‚OTæŸå¤± Kg', unit: 'kg', step: 0.1 },
            D10: { label: 'ç§åˆ†æµ“ç¼©ç‡ï¼ˆæ°¢æ°§åŒ–é“æ°´è§£å¸¦èµ°æ°´ï¼‰%', unit: '%', step: 0.1 },
            D11: { label: 'å¨Alâ‚‚Oâ‚ƒ ç§åˆ†å¸æ”¶COâ‚‚ Kg', unit: 'kg', step: 0.1 },
            D12: { label: 'A1(OH)â‚ƒ åˆ†ç¦»æ»¤é¥¼å«æ°´ç‡%', unit: '%', step: 0.1 },
            D13: { label: 'å¨Alâ‚‚Oâ‚ƒçš„Al(OH)â‚ƒæ–°æ´—æ°´é‡ kg', unit: 'kg', step: 1 },
            D14: { label: 'A1(OH)â‚ƒ æ´—æ¶¤æ»¤é¥¼å«æ°´ç‡%', unit: '%', step: 0.1 },
            D15: { label: 'ä¸€æ°´ç¢³é…¸é’ è‹›åŒ–Naâ‚‚OæŸå¤±é‡ Kg', unit: 'kg', step: 0.1 },
            D16: { label: 'è‹›åŒ–çŸ³ç°ä¹³è¿‡é‡ç³»æ•°', unit: '', step: 0.01 },
            D17: { label: 'è‹›åŒ–ç¢±æ¶²Nk g/l', unit: 'g/L', step: 0.1 },
            D18: { label: 'è‹›åŒ–ç‡%', unit: '%', step: 0.1 },
            F6: { label: 'åˆ†è§£ç‡%', unit: '%', step: 0.1 },
            F7: { label: 'ç§åˆ†æ¯æ¶²NK g/l', unit: 'g/L', step: 0.1 },
            F8: { label: 'ç§åˆ†æ¯æ¶²NC g/l', unit: 'g/L', step: 0.1 },
            F9: { label: 'ç§åˆ†æ¯æ¶²å¯†åº¦Ï g/cmÂ³', unit: 'g/cmÂ³', step: 0.001 },
            F10: { label: 'Alâ‚‚Oâ‚ƒæœºæ¢°æŸå¤±%(æ¹¿æ³•)', unit: '%', step: 0.01 },
            F11: { label: 'Alâ‚‚Oâ‚ƒæœºæ¢°æŸå¤±%ï¼ˆç«æ³•ï¼‰', unit: '%', step: 0.01 },
            F12: { label: 'COâ‚‚çš„è½¬åŒ–ç³»æ•°', unit: '', step: 0.01 },
            F13: { label: 'çŸ³ç°ä¹³å¯†åº¦g/cmÂ³', unit: 'g/cmÂ³', step: 0.001 },
            F14: { label: 'çŸ³ç°ä¹³æœ‰æ•ˆé’™', unit: '', step: 0.01 },
            F15: { label: 'çŸ³ç°ä¹³CaOå«é‡ g/l', unit: 'g/L', step: 0.1 },
            F16: { label: 'å¶æ»¤çŸ³ç°ä¹³æ·»åŠ æ¯”ä¾‹ %', unit: '%', step: 0.01 },
            F17: { label: 'çŸ³ç°ä¹³æ¸£æ¯”', unit: '', step: 0.1 },
            F18: { label: 'å¨çŸ¿é™„ç€æ°´', unit: 'kg', step: 0.1 },
        };

        function resolveProcessStep(key) {
            const fineStepKeys = new Set(['B8', 'B9', 'B11', 'B12', 'B14', 'B15', 'B17', 'B18', 'D8', 'D9', 'D10', 'D12', 'D14', 'F6', 'F7', 'F8', 'F9', 'F15']);
            return fineStepKeys.has(key) ? 0.01 : 0.1;
        }

        const balanceState = {
            mineralData: null,
            processParams: null,
            resultHTML: '<p class="loading-text">è¯·ç‚¹å‡»"å¼€å§‹è®¡ç®—"ä»¥ç”Ÿæˆå¹³è¡¡ç»“æœã€‚</p>',
            statusText: 'é»˜è®¤ä½¿ç”¨é¢„è®¾å‚æ•°ï¼Œå¯è‡ªè¡Œè°ƒæ•´ã€‚',
        };

        function ensureBalanceStateInitialized() {
            if (!balanceState.mineralData) {
                balanceState.mineralData = getDefaultMineralData();
            }
            if (!balanceState.processParams) {
                balanceState.processParams = { ...defaultProcessParams };
            }
            if (!processParamMeta.length) {
                processParamMeta = Object.entries(defaultProcessParamMeta).map(([key, meta]) => ({
                    key,
                    label: meta.label,
                    unit: meta.unit,
                    step: meta.step,
                    default_value: defaultProcessParams[key],
                }));
            }
        }

        previewForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            if (!file) {
                return;
            }
            cachedFile = file;

            const formData = new FormData();
            formData.append('file', file);

            previewDiv.innerHTML = '<p class="loading-text">æ­£åœ¨åŠ è½½å­—æ®µ...</p>';
            warningList.innerHTML = '<p class="loading-text">ç­‰å¾…åˆ†æ...</p>';

            const response = await fetch('/preview', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                previewDiv.innerHTML = `<p class="error">é¢„è§ˆå¤±è´¥: ${error.detail}</p>`;
                analysisForm.classList.add('hidden');
                return;
            }

        const data = await response.json();
        numericColumnsCache = data.numeric_columns || [];
        resetReportState();
        openReportBtn.disabled = true;
        suggestedColumns = data.suggested_key_parameters || [];
        tableCacheKey = data.cache_key || '';
        allColumnsCache = data.columns || [];
        tableChatActiveCacheKey = tableCacheKey;
        const currentChatState = getTableChatStateForCache(tableCacheKey);
        tableChatHistory = currentChatState.history || [];

        if (Array.isArray(data.metadata?.process_params) && data.metadata.process_params.length) {
            processParamMeta = data.metadata.process_params.map((item) => ({
                key: item.key,
                label: item.label || defaultProcessParamMeta[item.key]?.label || item.key,
                unit: item.unit || defaultProcessParamMeta[item.key]?.unit || '',
                step: item.step || defaultProcessParamMeta[item.key]?.step || 0.1,
                default_value: item.default_value ?? defaultProcessParams[item.key] ?? 0,
            }));
            balanceState.processParams = {};
            processParamMeta.forEach((item) => {
                balanceState.processParams[item.key] = Number(item.default_value ?? 0);
            });
        } else {
            processParamMeta = Object.entries(defaultProcessParamMeta).map(([key, meta]) => ({
                key,
                label: meta.label,
                unit: meta.unit,
                step: meta.step,
                default_value: meta.default_value,
            }));
            balanceState.processParams = { ...defaultProcessParams };
        }

        populateSelectors(data);
        previewDiv.innerHTML = renderPreview(data);
        analysisForm.classList.remove('hidden');
        warningList.innerHTML = '<p class="empty-state">å°šæœªæ£€æµ‹åˆ°é£é™©é¢„è­¦ã€‚</p>';
        if (tableCacheKey) {
            tableChatStatus.textContent = 'è¡¨æ ¼å·²å°±ç»ªï¼Œå¯è¿›è¡Œå¯¹è¯åˆ†æã€‚';
            openTableChatBtn.disabled = false;
        }

        openReportBtn.disabled = true;
        populateTableChatFocus(data.numeric_columns || []);
        });

        analysisForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!cachedFile) {
                warningList.innerHTML = '<p class="error">è¯·å…ˆä¸Šä¼ æ•°æ®å¹¶å®Œæˆå­—æ®µé¢„è§ˆã€‚</p>';
                return;
            }

            selectedColumns = getSelectedColumns();
            if (!selectedColumns.length) {
                resultDiv.innerHTML = '<p class="error">è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæŒ‡æ ‡è¿›è¡Œåˆ†æã€‚</p>';
                return;
            }

            const timestampColumn = timestampSelect.value || '';

            const formData = new FormData();
            formData.append('file', cachedFile);
            formData.append('selected_columns', selectedColumns.join(','));
            if (timestampColumn) {
                formData.append('selected_timestamp', timestampColumn);
            }

            setLoadingState();

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    const error = await response.json();
                    resultDiv.innerHTML = `<p class="error">åˆ†æå¤±è´¥: ${error.detail}</p>`;
                    return;
                }
                const data = await response.json();
                renderAnalysis(data);
            } catch (err) {
                resultDiv.innerHTML = `<p class="error">è¯·æ±‚å¤±è´¥: ${err}</p>`;
            }
        });

        openParameterAnalysisBtn?.addEventListener('click', () => {
            if (openParameterAnalysisBtn.hasAttribute('disabled')) {
                return;
            }
            if (!tableCacheKey) {
                alert('è¯·å…ˆä¸Šä¼ æ•°æ®å¹¶å®Œæˆé¢„è§ˆã€‚');
                return;
            }
            const selected = getSelectedColumns();
            const target = selected[0] || numericColumnsCache[0] || '';
            const params = new URLSearchParams({
                cache_key: tableCacheKey,
                parameter: target,
                time_range: '30d',
            });
            if (timestampSelect.value) {
                params.set('timestamp', timestampSelect.value);
            }
            window.open(`/parameter-analysis?${params.toString()}`, '_blank', 'noopener');
        });

        openModelLabBtn?.addEventListener('click', () => {
            if (openModelLabBtn.hasAttribute('disabled')) {
                return;
            }
            if (!tableCacheKey) {
                showToast('è¯·å…ˆå®Œæˆæ•°æ®é¢„è§ˆ', 'warning');
                return;
            }
            window.open('/model-lab', '_blank', 'noopener');
        });

        openKgGraphBtn?.addEventListener('click', () => {
            if (openKgGraphBtn.hasAttribute('disabled')) {
                return;
            }
            window.open('/kg-graph-lab', '_blank', 'noopener');
        });

        columnSearch.addEventListener('input', () => {
            filterColumns(columnSearch.value.trim());
        });

        selectAllBtn.addEventListener('click', () => {
            Array.from(columnsSelect.options).forEach((option) => {
                option.selected = true;
            });
        });

        clearAllBtn.addEventListener('click', () => {
            Array.from(columnsSelect.options).forEach((option) => {
                option.selected = false;
            });
        });

        openAiBtn.addEventListener('click', () => {
            aiModal.classList.remove('hidden');
            aiQuestionInput.value = aiChatState.draft || '';
            if (aiChatState.responseHTML) {
                aiResponseDiv.classList.remove('empty-state', 'error');
                aiResponseDiv.innerHTML = aiChatState.responseHTML;
            }
            aiQuotaInfo.textContent = aiChatState.quotaText || '';
        });

        closeAiBtn.addEventListener('click', () => {
            aiModal.classList.add('hidden');
        });

        aiQuestionInput.addEventListener('input', () => {
            aiChatState.draft = aiQuestionInput.value;
        });

        aiSendBtn.addEventListener('click', async () => {
            if (aiSendBtn.disabled) {
                return;
            }
            if (!tableCacheKey) {
                aiResponseDiv.classList.add('error');
                aiResponseDiv.textContent = 'è¯·å…ˆä¸Šä¼ æ•°æ®å¹¶å®Œæˆé¢„è§ˆã€‚';
                return;
            }
            const rawQuestion = aiQuestionInput.value.trim();
            if (!rawQuestion) {
                aiResponseDiv.classList.add('error');
                aiResponseDiv.textContent = 'è¯·è¾“å…¥è¦å’¨è¯¢çš„é—®é¢˜ã€‚';
                return;
            }

            aiResponseDiv.classList.remove('error');
            aiResponseDiv.classList.remove('empty-state');
            aiResponseDiv.textContent = 'AI æ­£åœ¨åˆ†æï¼Œè¯·ç¨å€™...';

            try {
                const response = await fetch('/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: aiProviderSelect.value,
                        message: rawQuestion,
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    aiResponseDiv.classList.add('error');
                    aiResponseDiv.textContent = data.error || 'AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                    aiQuotaInfo.textContent = data.reset_at
                        ? `å‰©ä½™å¯é—®æ¬¡æ•°ï¼š0 æ¬¡ï¼Œæœ¬å°æ—¶é‡ç½®æ—¶é—´ï¼š${data.reset_at}`
                        : '';
                    return;
                }

                aiResponseDiv.classList.remove('error');
                aiResponseDiv.innerHTML = `<p class="ai-answer">${(data.response || '').replace(/\n/g, '<br>')}</p>`;
                aiChatState.responseHTML = aiResponseDiv.innerHTML;
                if (data.remaining !== undefined && data.reset_at) {
                    aiQuotaInfo.textContent = `æ¨¡å‹ï¼š${(data.model_used || 'æœªçŸ¥')}ï¼Œå‰©ä½™å¯é—®æ¬¡æ•°ï¼š${data.remaining} æ¬¡ï¼Œæœ¬å°æ—¶é‡ç½®æ—¶é—´ï¼š${data.reset_at}`;
                    aiChatState.quotaText = aiQuotaInfo.textContent;
                } else {
                    aiQuotaInfo.textContent = '';
                    aiChatState.quotaText = '';
                }
            } catch (err) {
                aiResponseDiv.classList.add('error');
                aiResponseDiv.textContent = `AI è¯·æ±‚å¤±è´¥: ${err}`;
                aiChatState.responseHTML = `<p class="error">AI è¯·æ±‚å¤±è´¥: ${err}</p>`;
                aiQuotaInfo.textContent = '';
            }
        });

        aiModal.addEventListener('click', (event) => {
            if (event.target === aiModal || event.target.classList.contains('ai-modal-backdrop')) {
                aiModal.classList.add('hidden');
            }
        });

        let tableChatHistory = [];
        const tableChatState = {};
        let tableChatActiveCacheKey = '';

        const aiChatState = { responseHTML: '', quotaText: '', draft: '' };

        function isLocalProvider(provider) {
            return provider === 'tablegpt' || provider === 'ollama';
        }

        function getDefaultMineralData() {
            return {
                bauxite: [50, 8, 20, 3.76, 0, 5, 0, 0, 13.24],
                lime: [0, 0, 0, 0, 85, 0, 0, 0, 15],
                alumina: [99, 0, 0, 0, 0, 0, 0, 1, 0],
            };
        }

        function renderProcessInputs() {
            ensureBalanceStateInitialized();
            const items = processParamMeta.length
                ? processParamMeta
                : Object.entries(defaultProcessParamMeta).map(([key, meta]) => ({
                      key,
                      label: meta.label,
                      unit: meta.unit,
                      step: meta.step,
                  }));

            balanceParamGrid.innerHTML = items.map((item) => {
                const value = balanceState.processParams[item.key];
                const fallback = defaultProcessParamMeta[item.key] || {};
                const label = item.label || fallback.label || item.key;
                const unit = item.unit || fallback.unit || '';
                const step = item.step || fallback.step || 0.1;
                return `
                    <label class="param-field">
                        <span>${label}</span>
                        <input type="number" step="${step}" data-param="${item.key}" value="${value}">
                        <small>${unit}</small>
                    </label>
                `;
            }).join('');
        }

        function gatherMineralData() {
            const inputs = balanceModal.querySelectorAll('input[data-mineral]');
            const mineralData = { bauxite: Array(9).fill(0), lime: Array(9).fill(0), alumina: Array(9).fill(0) };
            inputs.forEach((input) => {
                const mineral = input.dataset.mineral;
                const index = Number(input.dataset.index);
                const value = Number(input.value || 0);
                mineralData[mineral][index] = value;
                balanceState.mineralData[mineral][index] = value;
            });
            return mineralData;
        }

        function gatherProcessParams() {
            const inputs = balanceModal.querySelectorAll('input[data-param]');
            const params = {};
            let modifiedCount = 0;
            inputs.forEach((input) => {
                const key = input.dataset.param;
                const defaultValue = defaultProcessParams[key];
                const value = Number(input.value || defaultValue);
                params[key] = value;
                balanceState.processParams[key] = value;
                if (Number.isFinite(value) && Math.abs(value - defaultValue) > 1e-6) {
                    modifiedCount += 1;
                }
            });
            return { params, modifiedCount };
        }

        async function executeBalanceCalculation() {
            const mineralData = gatherMineralData();
            const { params, modifiedCount } = gatherProcessParams();

            const payload = {
                mineral_data: mineralData,
                process_params: params
            };

            balanceStatusDiv.textContent = modifiedCount > 0 ? `å·²è°ƒæ•´ ${modifiedCount} ä¸ªå·¥è‰ºå‚æ•°ï¼Œè®¡ç®—å°†ä½¿ç”¨æœ€æ–°è¾“å…¥å€¼ã€‚` : 'ä½¿ç”¨é»˜è®¤é¢„è®¾å‚æ•°è¿›è¡Œè®¡ç®—ã€‚';
            balanceResultDiv.innerHTML = '<p class="loading-text">æ­£åœ¨æ‰§è¡Œå¹³è¡¡è®¡ç®—ï¼Œè¯·ç¨å€™...</p>';

            try {
                const response = await fetch('/calculate-equilibrium', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const error = await response.json();
                    balanceResultDiv.innerHTML = `<p class="error">å¹³è¡¡è®¡ç®—å¤±è´¥: ${error.detail || response.status}</p>`;
                    return;
                }
                const data = await response.json();
                balanceResultDiv.innerHTML = renderBalanceResult(data);
                balanceState.resultHTML = balanceResultDiv.innerHTML;
                balanceState.statusText = balanceStatusDiv.textContent || '';
            } catch (err) {
                balanceResultDiv.innerHTML = `<p class="error">å¹³è¡¡è®¡ç®—è¯·æ±‚å¤±è´¥: ${err}</p>`;
                balanceState.resultHTML = balanceResultDiv.innerHTML;
                balanceState.statusText = balanceStatusDiv.textContent || 'è¯·æ±‚å¤±è´¥';
            }
        }

        openBalanceBtn.addEventListener('click', async () => {
            ensureBalanceStateInitialized();
            balanceModal.classList.remove('hidden');
            applyBalanceState();
        });

        closeBalanceBtn.addEventListener('click', () => {
            persistBalanceState();
            balanceModal.classList.add('hidden');
        });

        balanceModal.addEventListener('click', (event) => {
            if (event.target === balanceModal || event.target.classList.contains('balance-modal-backdrop')) {
                persistBalanceState();
                balanceModal.classList.add('hidden');
            }
        });

        submitBalanceBtn.addEventListener('click', () => {
            executeBalanceCalculation();
        });

        resetBalanceBtn.addEventListener('click', () => {
            const defaultsMineral = getDefaultMineralData();
            const mineralInputs = balanceModal.querySelectorAll('input[data-mineral]');
            mineralInputs.forEach((input) => {
                const mineral = input.dataset.mineral;
                const index = Number(input.dataset.index);
                const value = defaultsMineral[mineral][index];
                input.value = value;
                balanceState.mineralData[mineral][index] = value;
            });

            const paramInputs = balanceModal.querySelectorAll('input[data-param]');
            paramInputs.forEach((input) => {
                const key = input.dataset.param;
                const value = defaultProcessParams[key];
                input.value = value;
                balanceState.processParams[key] = value;
            });
            balanceStatusDiv.textContent = 'å·²æ¢å¤é»˜è®¤é¢„è®¾å‚æ•°ï¼Œè¯·é‡æ–°è®¡ç®—ã€‚';
            balanceState.statusText = balanceStatusDiv.textContent;
            balanceResultDiv.innerHTML = '<p class="loading-text">è¯·ç‚¹å‡»"å¼€å§‹è®¡ç®—"ä»¥ç”Ÿæˆå¹³è¡¡ç»“æœã€‚</p>';
            balanceState.resultHTML = balanceResultDiv.innerHTML;
        });

        function applyBalanceState() {
            ensureBalanceStateInitialized();
            renderProcessInputs();

            const mineralInputs = balanceModal.querySelectorAll('input[data-mineral]');
            mineralInputs.forEach((input) => {
                const mineral = input.dataset.mineral;
                const index = Number(input.dataset.index);
                input.value = balanceState.mineralData[mineral][index];
            });

            const paramInputs = balanceModal.querySelectorAll('input[data-param]');
            paramInputs.forEach((input) => {
                const key = input.dataset.param;
                input.value = balanceState.processParams[key];
            });

            balanceResultDiv.innerHTML = balanceState.resultHTML;
            balanceStatusDiv.textContent = balanceState.statusText;
        }

        function persistBalanceState() {
            gatherMineralData();
            gatherProcessParams();
            balanceState.resultHTML = balanceResultDiv.innerHTML;
            balanceState.statusText = balanceStatusDiv.textContent || '';
        }

        function populateSelectors(data) {
            populateColumns(data.numeric_columns || [], data.suggested_key_parameters || []);
            populateTimestampOptions(data);
            if (data.numeric_columns && data.numeric_columns.length) {
                openParameterAnalysisBtn?.removeAttribute('disabled');
                openModelLabBtn?.removeAttribute('disabled');
                openKgGraphBtn?.removeAttribute('disabled');
            } else {
                openParameterAnalysisBtn?.setAttribute('disabled', 'disabled');
                openModelLabBtn?.setAttribute('disabled', 'disabled');
                openKgGraphBtn?.setAttribute('disabled', 'disabled');
            }
        }

        function populateColumns(columns, suggested) {
            columnsSelect.innerHTML = '';
            columns.forEach((column) => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                columnsSelect.appendChild(option);
            });
            Array.from(columnsSelect.options).forEach((option, idx) => {
                option.selected = suggested.includes(option.value) || idx < 3;
            });
        }

        function filterColumns(keyword) {
            const lowerKeyword = keyword.toLowerCase();
            Array.from(columnsSelect.options).forEach((option) => {
                const match = option.value.toLowerCase().includes(lowerKeyword);
                option.hidden = !match;
            });
        }

        function populateTimestampOptions(data) {
            timestampSelect.innerHTML = '<option value="">è‡ªåŠ¨è¯†åˆ«</option>';
            (data.timestamp_candidates || []).forEach((column) => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                if (data.metadata.timestamp_column === column) {
                    option.selected = true;
                }
                timestampSelect.appendChild(option);
            });
        }

        function getSelectedColumns() {
            return Array.from(columnsSelect.selectedOptions).map((option) => option.value);
        }

        function renderPreview(data) {
            const metadata = data.metadata;
            const timestamps = data.timestamp_candidates || [];
            const keyParams = data.suggested_key_parameters || [];
            const missingRatio = typeof metadata.missing_ratio === 'number' ? metadata.missing_ratio : 0;

            return `
                <div class="preview-metrics">
                    <div class="metric-card"><span>è®°å½•æ•°</span><strong>${metadata.row_count}</strong></div>
                    <div class="metric-card"><span>å­—æ®µæ•°</span><strong>${metadata.column_count}</strong></div>
                    <div class="metric-card"><span>ç¼ºå¤±ç‡</span><strong>${(missingRatio * 100).toFixed(1)}%</strong></div>
                </div>
                <div class="preview-tags">
                    <h3>æ—¶é—´å­—æ®µå€™é€‰</h3>
                    ${timestamps.length ? `<div class="tag-list">${timestamps.map((item) => `<span class="tag">${item}</span>`).join('')}</div>` : '<p class="tag-placeholder">æœªè¯†åˆ«</p>'}
                </div>
            `;
        }

        function setLoadingState() {
            resultDiv.innerHTML = '<p class="loading-text">åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>';
            statChartDiv.innerHTML = '<p class="loading-text">è®¡ç®—é£é™©æ’å...</p>';
            riskTrendDiv.innerHTML = '<p class="loading-text">ç”Ÿæˆè¶‹åŠ¿é¢„æµ‹...</p>';
            riskSourceDiv.innerHTML = '<p class="loading-text">è¯†åˆ«é£é™©æº...</p>';
            forecastChartDiv.innerHTML = '<p class="loading-text">ç»˜åˆ¶è¶‹åŠ¿å›¾...</p>';
            forecastLegend.innerHTML = '';
        }

        function renderAnalysis(data) {
            const { report, forecast } = data;
            renderWarnings(report);
            renderDetails(report);
            renderStats(report);
            renderRiskSources(report);
            renderForecastContent(forecast);

            if (report && report.length) {
                openReportBtn.disabled = false;
                exportExcelBtn.disabled = false;
                reportState.columns = [...selectedColumns];
                reportState.timestampColumn = timestampSelect.value || '';
                reportState.content = '';
                reportState.draft = '';
                reportState.generatedAt = '';
            } else {
                openReportBtn.disabled = true;
                exportExcelBtn.disabled = true;
                resetReportState();
            }
        }

        function renderWarnings(report) {
            const alerts = report.filter((item) => item.current_status !== 'æ­£å¸¸');
            if (!alerts.length) {
                warningList.innerHTML = '<p class="empty-state">æš‚æ— å¼‚å¸¸æŒ‡æ ‡ï¼Œç³»ç»Ÿå¤„äºç¨³æ€ã€‚</p>';
                return;
            }
            warningList.innerHTML = alerts.map((item) => {
                const recs = Array.isArray(item.recommendations) ? item.recommendations : [];
                return `
                    <div class="warning-item ${item.current_status === 'é«˜' ? 'warning-high' : 'warning-low'}">
                        <div>
                            <strong>${item.parameter}</strong>
                            <span>${item.current_status} Â· ${item.trend}</span>
                        </div>
                        <p>å»ºè®®ï¼š${recs.at(0) || 'è¯·å…³æ³¨å‚æ•°æ³¢åŠ¨æƒ…å†µã€‚'}</p>
                    </div>
                `;
            }).join('');
        }

        function renderDetails(report) {
            if (!report.length) {
                resultDiv.innerHTML = '<p class="empty-state">æœªè·å–åˆ°æœ‰æ•ˆæŒ‡æ ‡ã€‚</p>';
                return;
            }
            resultDiv.innerHTML = report.map((item) => {
                const recs = Array.isArray(item.recommendations) ? item.recommendations : [];
                const factors = Array.isArray(item.influence_factors) ? item.influence_factors : [];
                    const latestText = item.latest_value !== null && item.latest_value !== undefined ? formatNumber(item.latest_value) : 'â€”';
                    const meanText = item.mean_value !== null && item.mean_value !== undefined ? formatNumber(item.mean_value) : 'â€”';
                    const stdText = item.std_dev !== null && item.std_dev !== undefined ? formatNumber(item.std_dev) : 'â€”';
                return `
                    <article class="detail-card">
                        <header>
                            <h3>${item.parameter}</h3>
                            <span class="status-badge status-${item.current_status}">${item.current_status}</span>
                        </header>
                        <p><span>çŸ­æœŸè¶‹åŠ¿ï¼š</span>${item.trend}</p>
                            <p><span>æœ€æ–°å€¼ï¼š</span>${latestText}</p>
                            <p><span>å‡å€¼ / æ ‡å‡†å·®ï¼š</span>${meanText} / ${stdText}</p>
                        <p><span>é¢„æµ‹æ‘˜è¦ï¼š</span>${item.forecast_summary || 'â€”â€”'}</p>
                        <p><span>é¢„æµ‹è¶‹åŠ¿ï¼š</span>${item.forecast_trend}</p>
                        <p><span>å½±å“å› å­ï¼š</span>${factors.length ? factors.join('ï¼Œ') : 'å¾…è¯†åˆ«'}</p>
                        <div class="recommendations">
                            ${recs.length ? recs.map((rec) => `<span>${rec}</span>`).join('') : '<span>æœªæä¾›å»ºè®®</span>'}
                        </div>
                    </article>
                `;
            }).join('');
        }

        function renderStats(report) {
            if (!report.length) {
                statChartDiv.innerHTML = '<p class="empty-state">æš‚æ— ç»Ÿè®¡ç»“æœã€‚</p>';
                return;
            }
            const sorted = [...report].sort((a, b) => (b.std_dev || 0) - (a.std_dev || 0)).slice(0, 5);
            statChartDiv.innerHTML = `
                <ol class="ranking-list">
                    ${sorted.map((item, index) => `
                        <li>
                            <span class="rank">${index + 1}</span>
                            <div>
                                <strong>${item.parameter}</strong>
                                <small>æ³¢åŠ¨åº¦ï¼š${formatNumber(item.std_dev)}</small>
                            </div>
                            <span class="trend">${item.trend}</span>
                        </li>
                    `).join('')}
                </ol>
            `;
        }

        function renderRiskSources(report) {
            const influenceCounter = {};
            report.forEach((item) => {
                const factors = Array.isArray(item.influence_factors) ? item.influence_factors : [];
                factors.forEach((factor) => {
                    if (!factor) return;
                    influenceCounter[factor] = (influenceCounter[factor] || 0) + 1;
                });
            });
            const sorted = Object.entries(influenceCounter)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            if (!sorted.length) {
                riskSourceDiv.innerHTML = '<p class="empty-state">æš‚æ— é£é™©æºæ•°æ®ã€‚</p>';
                return;
            }
            const total = sorted.reduce((sum, [, count]) => sum + count, 0);
            riskSourceDiv.innerHTML = `
                <div class="risk-source-list">
                    ${sorted.map(([factor, count]) => `
                        <div class="risk-source-item">
                            <span>${factor}</span>
                            <strong>${Math.round((count / total) * 100)}%</strong>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderForecastContent(forecast) {
            renderForecastSummary(forecast);
            renderForecastChart(forecast);
        }

        function renderForecastSummary(forecast) {
            if (!forecast || !forecast.predictions) {
                riskTrendDiv.innerHTML = '<p class="empty-state">æš‚æ— é¢„æµ‹ç»“æœã€‚</p>';
                return;
            }
            selectedColumns = getSelectedColumns();
            if (!selectedColumns.length) {
                riskTrendDiv.innerHTML = '<p class="empty-state">æ‰€é€‰æŒ‡æ ‡ç¼ºå°‘é¢„æµ‹æ•°æ®ã€‚</p>';
                return;
            }
            riskTrendDiv.innerHTML = `
                <ul class="trend-list">
                    ${selectedColumns.slice(0, 6).map((column) => {
                        const summary = forecast.summary?.[column];
                        const trend = forecast.trends?.[column];
                        return `
                            <li>
                                <strong>${column}</strong>
                                <span>${summary || trend || 'æš‚æ— æ‘˜è¦'}</span>
                            </li>
                        `;
                    }).join('')}
                </ul>
            `;
        }

        function renderForecastChart(forecast) {
            forecastLegend.innerHTML = '';
            if (!forecast || !forecast.predictions) {
                forecastChartDiv.innerHTML = '<p class="empty-state">æš‚æ— é¢„æµ‹æ•°æ®ã€‚</p>';
                return;
            }

            selectedColumns = getSelectedColumns();
            const series = selectedColumns
                .map((column, index) => {
                    const historyTail = (forecast.history_tail?.[column] || []);
                    const historyPoints = historyTail
                        .map((entry) => ({
                            type: 'history',
                            label: entry.index,
                            value: Number(entry.value),
                        }))
                        .filter((point) => !Number.isNaN(point.value));

                    if (!historyPoints.length) {
                        return null;
                    }
                    return {
                        column,
                        color: palette[index % palette.length],
                        points: historyPoints,
                        historyCount: historyPoints.length,
                    };
                })
                .filter(Boolean);

            if (!series.length) {
                forecastChartDiv.innerHTML = '<p class="empty-state">æ‰€é€‰æŒ‡æ ‡ç¼ºå°‘é¢„æµ‹æ•°æ®ã€‚</p>';
                return;
            }

            const labels = generateUnifiedLabels(series);
            const allValues = series.flatMap((item) => item.points.map((point) => point.value));
            const minValue = Math.min(...allValues);
            const maxValue = Math.max(...allValues);
            const padding = (maxValue - minValue) * 0.1 || 1;
            const chartMin = minValue - padding;
            const chartMax = maxValue + padding;
            const width = 640;
            const height = 320;
            const leftPadding = 60;
            const bottomPadding = 80;
            const topPadding = 20;
            const rightPadding = 20;

            const axisLines = `
                <line x1="${leftPadding}" y1="${height - bottomPadding}" x2="${width - rightPadding}" y2="${height - bottomPadding}" class="axis-line" />
                <line x1="${leftPadding}" y1="${topPadding}" x2="${leftPadding}" y2="${height - bottomPadding}" class="axis-line" />
            `;

            const yTicks = 4;
            const yTickElements = Array.from({ length: yTicks + 1 }, (_, index) => {
                const value = chartMin + ((chartMax - chartMin) * index) / yTicks;
                const y = height - bottomPadding - ((value - chartMin) / (chartMax - chartMin)) * (height - topPadding - bottomPadding);
                return `
                    <line x1="${leftPadding}" y1="${y}" x2="${width - rightPadding}" y2="${y}" class="chart-grid-line" />
                    <text x="${leftPadding - 10}" y="${y + 4}" class="axis-label">${formatNumber(value)}</text>
                `;
            }).join('');

            const xTickElements = labels.map((label, index) => {
                const x = leftPadding + (index / Math.max(1, labels.length - 1)) * (width - leftPadding - rightPadding);
                const y = height - bottomPadding + 32;
                return `<g transform="translate(${x},${y}) rotate(-30)"><text class="axis-label" text-anchor="end">${label}</text></g>`;
            }).join('');

            const lines = series.map((item) => {
                const points = item.points.map((point, index) => {
                    const x = leftPadding + (index / Math.max(1, labels.length - 1)) * (width - leftPadding - rightPadding);
                    const y = height - bottomPadding - ((point.value - chartMin) / (chartMax - chartMin)) * (height - topPadding - bottomPadding);
                    return `${x},${y}`;
                }).join(' ');

                const dots = item.points.map((point, index) => {
                    const x = leftPadding + (index / Math.max(1, labels.length - 1)) * (width - leftPadding - rightPadding);
                    const y = height - bottomPadding - ((point.value - chartMin) / (chartMax - chartMin)) * (height - topPadding - bottomPadding);
                    const attributes = `data-point="${point.type}" data-column="${item.column}" data-label="${point.label}" data-value="${point.value}" cx="${x}" cy="${y}"`;
                    return `<circle ${attributes} r="4" class="chart-dot history" fill="${item.color}" />`;
                }).join('');

                return `
                    <polyline points="${points}" fill="none" stroke="${item.color}" stroke-width="2.5" />
                    ${dots}
                `;
            }).join('');

            forecastChartDiv.innerHTML = `
                <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                    ${axisLines}
                    ${yTickElements}
                    ${xTickElements}
                    ${lines}
                </svg>
            `;

            attachChartTooltip();

            forecastLegend.innerHTML = series.map((item) => `
                <span class="legend-item"><span class="legend-swatch" style="background:${item.color}"></span>${item.column}</span>
            `).join('');
        }

        function generateUnifiedLabels(series) {
            const maxLength = Math.max(...series.map((item) => item.points.length), 0);
            const labels = [];
            for (let index = 0; index < maxLength; index += 1) {
                const labelSource = series.find((item) => item.points[index]);
                const label = labelSource?.points[index]?.label ?? `T${index}`;
                labels.push(label);
            }
            return labels;
        }

        function buildStarPath(cx, cy, outerRadius, innerRadius, points) {
            const step = Math.PI / points;
            const coordinates = [];
            for (let i = 0; i < 2 * points; i += 1) {
                const radius = i % 2 === 0 ? outerRadius : innerRadius;
                const angle = i * step - Math.PI / 2;
                const x = cx + radius * Math.cos(angle);
                const y = cy + radius * Math.sin(angle);
                coordinates.push(`${x},${y}`);
            }
            return coordinates.join(' ');
        }

        function attachChartTooltip() {
            let tooltip = document.getElementById('chart-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'chart-tooltip';
                tooltip.className = 'chart-tooltip hidden';
                forecastChartDiv.appendChild(tooltip);
            }

            const hideTooltip = () => {
                tooltip.classList.add('hidden');
            };

            const dots = forecastChartDiv.querySelectorAll('[data-point]');
            dots.forEach((dot) => {
                dot.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const rect = forecastChartDiv.getBoundingClientRect();
                    const column = dot.getAttribute('data-column') || '';
                    const label = dot.getAttribute('data-label') || '';
                    const value = dot.getAttribute('data-value');

                    tooltip.innerHTML = `
                        <strong>${column}</strong><br>
                        <span>${label}</span><br>
                        <span>${formatNumber(Number(value))}</span>
                    `;

                    const clientX = event.clientX;
                    const clientY = event.clientY;
                    tooltip.style.left = `${clientX - rect.left + 12}px`;
                    tooltip.style.top = `${clientY - rect.top - 10}px`;
                    tooltip.classList.remove('hidden');
                });
            });

            forecastChartDiv.addEventListener('click', hideTooltip);
        }

        function formatNumber(value) {
            if (value === null || value === undefined || Number.isNaN(value)) {
                return 'â€”';
            }
            return Number(value).toFixed(2);
        }

        let reportGenerating = false;

        function formatReportTime(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return value;
            }
            return date.toLocaleString('zh-CN', { hour12: false });
        }

        function setReportMessage(text, state = 'info') {
            if (!reportMessage) return;
            reportMessage.textContent = text;
            reportMessage.classList.remove('empty-state', 'error');
            if (state === 'empty') {
                reportMessage.classList.add('empty-state');
            } else if (state === 'error') {
                reportMessage.classList.add('error');
            }
        }

        function applyReportStateToUI() {
            if (!reportColumnsSpan || !reportTimestampSpan) return;
            reportColumnsSpan.textContent = reportState.columns.length ? reportState.columns.join('ï¼Œ') : '--';
            reportTimestampSpan.textContent = reportState.timestampColumn || 'è‡ªåŠ¨è¯†åˆ«';
            const text = reportState.draft || reportState.content || '';
            if (reportEditor) {
                reportEditor.value = text;
                if (text.trim()) {
                    reportEditor.removeAttribute('disabled');
                } else {
                    reportEditor.setAttribute('disabled', 'disabled');
                }
            }
            if (reportExportBtn) {
                reportExportBtn.disabled = !text.trim();
            }
            if (text.trim()) {
                const label = reportState.generatedAt
                    ? `ç”Ÿæˆæ—¶é—´ï¼š${formatReportTime(reportState.generatedAt)}`
                    : 'æŠ¥è¡¨å·²ç”Ÿæˆï¼Œå¯ç¼–è¾‘å†…å®¹ã€‚';
                setReportMessage(label, 'info');
            } else {
                setReportMessage('è¯·ç”ŸæˆæŠ¥è¡¨åæŸ¥çœ‹ã€‚', 'empty');
            }
        }

        function persistReportState() {
            if (reportEditor) {
                reportState.draft = reportEditor.value;
            }
        }

        async function generateReport() {
            if (!tableCacheKey) {
                setReportMessage('è¯·å…ˆä¸Šä¼ æ•°æ®å¹¶å®Œæˆåˆ†æã€‚', 'error');
                reportExportBtn?.setAttribute('disabled', 'disabled');
                return;
            }

            const columns = reportState.columns.length ? [...reportState.columns] : getSelectedColumns();
            if (!columns.length) {
                setReportMessage('è¯·å…ˆå®ŒæˆæŒ‡æ ‡åˆ†æï¼Œå†ç”ŸæˆæŠ¥è¡¨ã€‚', 'error');
                reportExportBtn?.setAttribute('disabled', 'disabled');
                return;
            }

            if (reportGenerating) {
                return;
            }
            reportGenerating = true;
            setReportMessage('æŠ¥è¡¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...', 'info');
            reportEditor?.setAttribute('disabled', 'disabled');
            openReportBtn?.setAttribute('disabled', 'disabled');
            reportExportBtn?.setAttribute('disabled', 'disabled');

            const timestampValue = reportState.timestampColumn || timestampSelect.value || '';

            try {
                const response = await fetch('/report/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cache_key: tableCacheKey,
                        columns,
                        timestamp_column: timestampValue,
                    }),
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.detail || data.error || 'ç”Ÿæˆå¤±è´¥');
                }
                const report = data.report || {};
                reportState.content = report.content || '';
                reportState.draft = reportState.content;
                reportState.generatedAt = report.generated_at || '';
                reportState.columns = Array.isArray(report.columns) && report.columns.length ? report.columns : columns;
                reportState.timestampColumn = report.timestamp_column || timestampValue || '';
                applyReportStateToUI();
                openReportBtn?.removeAttribute('disabled');
            } catch (err) {
                setReportMessage(`æŠ¥è¡¨ç”Ÿæˆå¤±è´¥ï¼š${err.message || err}`, 'error');
                reportExportBtn?.setAttribute('disabled', 'disabled');
                openReportBtn?.removeAttribute('disabled');
            } finally {
                reportGenerating = false;
                reportEditor?.removeAttribute('disabled');
            }
        }

        function renderBalanceResult(result) {
            if (!result) {
                return '<p class="error">æœªè·å–åˆ°å¹³è¡¡è®¡ç®—ç»“æœã€‚</p>';
            }
            const sections = [
                { key: 'materials', title: 'ä¸»è¦ç‰©æ–™å¹³è¡¡', unit: 'kg/h' },
                { key: 'efficiency', title: 'å·¥è‰ºæ•ˆç‡æŒ‡æ ‡', unit: '' },
                { key: 'intermediate', title: 'ä¸­é—´è¿‡ç¨‹å‚æ•°', unit: '' }
            ];
            return sections.map(({ key, title, unit }) => {
                const items = result[key] || {};
                const rows = Object.entries(items).map(([name, value]) => {
                    const label = formatBalanceField(name);
                    const displayValue = formatNumber(value);
                    const unitText = resolveBalanceUnit(key, name, unit);
                    return `<tr><td>${label}</td><td>${displayValue}</td><td>${unitText}</td></tr>`;
                }).join('');
                return `<section><h3>${title}</h3><table class="balance-table"><thead><tr><th>é¡¹ç›®</th><th>æ•°å€¼</th><th>å•ä½</th></tr></thead><tbody>${rows}</tbody></table></section>`;
            }).join('');
        }

        function formatBalanceField(key) {
            const mapping = {
                A28: 'é“çŸ¿çŸ³éœ€æ±‚é‡',
                B28: 'çŸ³ç°éœ€æ±‚é‡',
                L48: 'è¡¥å……ç¢±æ¶²é‡',
                L49: 'è‹›åŒ–ç¢±æ¶²é‡',
                L47: 'å¾ªç¯æ¯æ¶²é‡',
                L50: 'åŸçŸ¿æµ†é‡',
                L57: 'æº¶å‡ºæ¶²é‡',
                D6: 'æº¶å‡ºçŸ¿æµ†è‡ªç„¶è’¸å‘æ°´',
                A61: 'æº¶å‡ºèµ¤æ³¥é‡',
                B65: 'å¼ƒèµ¤æ³¥é‡',
                G80: 'ç²—æ¶²é‡',
                J80: 'ç²¾æ¶²é‡',
                J82: 'èµ¤æ³¥æ´—æ°´é‡',
                H82: 'èµ¤æ³¥ä¸€æ¬¡æ´—æ¶²',
                C108: 'æ°¢æ°§åŒ–é“äº§é‡',
                H115: 'ç§åˆ†æ¯æ¶²é‡',
                G74: 'è’¸å‘æ°´é‡',
                H108: 'çŸ³ç°ä¹³éœ€æ±‚é‡',
                E80: 'ç¨€é‡Šæ¶²é‡',
                wash_water_total: 'æ°¢æ°§åŒ–é“æ€»æ´—æ°´',
                F136: 'å¾ªç¯æ•ˆç‡',
                F137: 'ç†è®ºæº¶å‡ºç‡',
                F138: 'å®é™…æº¶å‡ºç‡',
                F139: 'ç›¸å¯¹æº¶å‡ºç‡',
                F140: 'ç†è®ºå‡è€—',
                F142: 'åˆ†è§£ç‡',
                F143: 'çŸ¿æµ†æŠ˜åˆæ¯”',
                B24: 'æº¶å‡ºæ®‹æ¸£ SiOâ‚‚ å«é‡',
                A26: 'æ€»æŸå¤±ç‡',
                B26: 'æœ‰æ•ˆåˆ©ç”¨ç‡',
                A35: 'COâ‚‚ éœ€æ±‚é‡',
                B35: 'çŸ³ç°éœ€æ±‚é‡',
                C35: 'å·¥è‰ºæ°´éœ€æ±‚',
                D35: 'æ€» COâ‚‚ éœ€æ±‚',
                E35: 'æ€»çŸ³ç°éœ€æ±‚',
                H53: 'æº¶å‡ºèµ¤æ³¥æ€»é‡',
                I53: 'æº¶å‡ºèµ¤æ³¥æ°´åˆ†',
                A63: 'è‹›åŒ–éœ€æ±‚ç¢±é‡',
                B63: 'è‹›åŒ–éœ€æ±‚çŸ³ç°',
                E61: 'æ´—æ¶¤æ°´é‡',
                I80: 'å‹æ»¤æ°´é‡',
                K80: 'å¶æ»¤çŸ³ç°ä¹³é‡',
                A108: 'åˆ†è§£æ¶²é‡',
                B108: 'åˆ†è§£ COâ‚‚',
                C108: 'åˆ†è§£æ€»æ¶²é‡'
            };
            return mapping[key] || key;
        }

        function resolveBalanceLabel(sectionKey, key) {
            const mapping = {
                materials: {
                    bauxite: 'é“åœŸçŸ¿',
                    lime: 'çŸ³ç°',
                    alumina: 'æˆå“æ°§åŒ–é“',
                },
                process: {
                    B6: 'å¾ªç¯æ¯æ¶² Nk',
                    B7: 'å¾ªç¯æ¯æ¶² Nc',
                    B8: 'å¾ªç¯æ¯æ¶² Î±k',
                    B9: 'å¾ªç¯æ¯æ¶²å¯†åº¦ Ï',
                    B10: 'è¡¥å……ç¢±æ¶² Nk',
                    B11: 'è¡¥å……ç¢±æ¶²å¯†åº¦ Ï',
                    B12: 'çŸ³ç°æ·»åŠ é‡',
                    B13: 'èµ¤æ³¥é“ç¡…æ¯”',
                    B14: 'èµ¤æ³¥é’ ç¡…æ¯”',
                    B15: 'èµ¤æ³¥ç¼å‡',
                    B16: 'æº¶å‡ºç¨€é‡Š Nk',
                    B17: 'æº¶å‡ºç¨€é‡Š Î±k',
                    B18: 'æº¶å‡º Î±k',
                    B19: 'æº¶å‡ºç¨€é‡Šå¯†åº¦ Ï',
                    B20: 'æ²‰é™åº•æµå›ºå«',
                    B21: 'æœ«æ¬¡æ´—æ¶¤åº•æµå›ºå«',
                    D6: 'æº¶å‡ºçŸ¿æµ†è’¸å‘æ°´',
                    D7: 'èµ¤æ³¥é™„æ¶² Naâ‚‚O æŸå¤±',
                    D8: 'æº¶å‡ºæ°´è§£é“',
                    D9: 'å¨å¹²èµ¤æ³¥é™„æ¶²æŸå¤±',
                    D10: 'ç§åˆ†æµ“ç¼©ç‡',
                    D11: 'å¨æ°§åŒ–é“å¸æ”¶ COâ‚‚',
                    D12: 'æ»¤é¥¼å«æ°´ç‡',
                    D13: 'å¨æ°§åŒ–é“æ–°æ´—æ°´',
                    D14: 'æ´—æ¶¤æ»¤é¥¼å«æ°´ç‡',
                    D15: 'æœªçŸ¥å‚æ•° D15',
                    D16: 'æœªçŸ¥å‚æ•° D16',
                    D17: 'æœªçŸ¥å‚æ•° D17',
                    D18: 'æœªçŸ¥å‚æ•° D18',
                    F6: 'æœªçŸ¥å‚æ•° F6',
                    F7: 'æœªçŸ¥å‚æ•° F7',
                    F8: 'æœªçŸ¥å‚æ•° F8',
                    F9: 'æœªçŸ¥å‚æ•° F9',
                    F10: 'æœªçŸ¥å‚æ•° F10',
                    F11: 'æœªçŸ¥å‚æ•° F11',
                    F12: 'æœªçŸ¥å‚æ•° F12',
                    F13: 'æœªçŸ¥å‚æ•° F13',
                    F14: 'æœªçŸ¥å‚æ•° F14',
                    F15: 'æœªçŸ¥å‚æ•° F15',
                    F16: 'æœªçŸ¥å‚æ•° F16',
                    F17: 'æœªçŸ¥å‚æ•° F17',
                    F18: 'æœªçŸ¥å‚æ•° F18',
                },
                efficiency: {
                    F136: 'å¾ªç¯æ•ˆç‡',
                    F137: '%',
                    F138: '%',
                    F139: '%',
                    F140: 'kg/t',
                    F142: '%',
                    F143: 'mÂ³/t'
                },
                intermediate: {
                    B24: '%',
                    A26: '%',
                    B26: '%',
                    A35: 'kg/h',
                    B35: 'kg/h',
                    C35: 'kg/h',
                    D35: 'kg/h',
                    E35: 'kg/h',
                    H53: 'kg/h',
                    I53: 'kg/h',
                    A63: 'kg/h',
                    B63: 'kg/h',
                    E61: 'kg/h',
                    I80: 'kg/h',
                    K80: 'kg/h',
                    A108: 'kg/h',
                    B108: 'kg/h',
                    C108: 'kg/h'
                }
            };
            const group = mapping[sectionKey] || mapping.process;
            if (sectionKey === 'intermediate' || sectionKey === 'efficiency') {
                return (mapping[sectionKey] && mapping[sectionKey][key]) || key;
            }
            return (group && group[key]) || key;
        }

        function resolveBalanceUnit(sectionKey, fieldKey, defaultUnit) {
            const customUnits = {
                efficiency: {
                    F136: 'kg/mÂ³',
                    F137: '%',
                    F138: '%',
                    F139: '%',
                    F140: 'kg/t',
                    F142: '%',
                    F143: 'mÂ³/t'
                },
                intermediate: {
                    B24: '%',
                    A26: '%',
                    B26: '%',
                    A35: 'kg/h',
                    B35: 'kg/h',
                    C35: 'kg/h',
                    D35: 'kg/h',
                    E35: 'kg/h',
                    H53: 'kg/h',
                    I53: 'kg/h',
                    A63: 'kg/h',
                    B63: 'kg/h',
                    E61: 'kg/h',
                    I80: 'kg/h',
                    K80: 'kg/h',
                    A108: 'kg/h',
                    B108: 'kg/h',
                    C108: 'kg/h'
                }
            };

            if (sectionKey === 'materials') {
                return defaultUnit || 'kg/h';
            }
            const sectionUnits = customUnits[sectionKey] || {};
            return sectionUnits[fieldKey] || defaultUnit || '';
        }

        function formatQuotaText(data) {
            if (data && Number.isInteger(data.remaining) && data.reset_at) {
                return `å‰©ä½™å¯ç”¨æ¬¡æ•°ï¼š${data.remaining}ï¼Œé‡ç½®æ—¶é—´ï¼š${data.reset_at}`;
            }
            if (data && Number.isInteger(data.remaining)) {
                return `å‰©ä½™å¯ç”¨æ¬¡æ•°ï¼š${data.remaining}`;
            }
            return '';
        }
        function renderAnswerHtml(rawText) {
            if (!rawText) {
                return '';
            }
            const segments = rawText
                .split(/\n{2,}/)
                .map(segment => segment.trim())
                .filter(Boolean)
                .map(segment => segment.replace(/\n/g, '<br>'));

            return segments.map(paragraph => `<p>${paragraph}</p>`).join('');
        }

        function getTableChatStateForCache(cacheKey) {
            const key = cacheKey || 'default';
            if (!tableChatState[key]) {
                tableChatState[key] = { responseHTML: '', quotaText: '', draft: '', history: [] };
            }
            return tableChatState[key];
        }

        openTableChatBtn.addEventListener('click', () => {
            if (!tableCacheKey) {
                tableChatStatus.textContent = 'è¯·å…ˆä¸Šä¼ å¹¶é¢„è§ˆæ•°æ®ã€‚';
                return;
            }
            tableChatActiveCacheKey = tableCacheKey;
            const chatState = getTableChatStateForCache(tableCacheKey);
            tableChatModal.classList.remove('hidden');
            tableChatHistory = chatState.history || [];
            renderTableChatOutput();
            refreshProviderStatus();
        });

        closeTableChatBtn.addEventListener('click', () => {
            persistTableChatState();
            tableChatModal.classList.add('hidden');
        });

        tableChatModal.addEventListener('click', (event) => {
            if (event.target === tableChatModal || event.target.classList.contains('table-chat-backdrop')) {
                persistTableChatState();
                tableChatModal.classList.add('hidden');
            }
        });

        tableChatProviderSelect.addEventListener('change', () => {
            const chatState = getTableChatStateForCache(tableChatActiveCacheKey || tableCacheKey);
            tableChatHistory = chatState.history || [];
            renderTableChatOutput();
        });

        tableChatQuestion.addEventListener('input', () => {
            const activeKey = tableChatActiveCacheKey || tableCacheKey;
            if (!activeKey) {
                return;
            }
            const chatState = getTableChatStateForCache(activeKey);
            chatState.draft = tableChatQuestion.value;
        });

        tableChatSendBtn.addEventListener('click', async () => {
            if (tableChatSendBtn.hasAttribute('disabled')) {
                return;
            }
            if (!tableCacheKey) {
                tableChatResponse.classList.add('error');
                tableChatResponse.textContent = 'è¯·å…ˆä¸Šä¼ æ•°æ®å¹¶å®Œæˆé¢„è§ˆã€‚';
                return;
            }
            const chatState = getTableChatStateForCache(tableCacheKey);
            tableChatActiveCacheKey = tableCacheKey;
            const rawQuestion = (tableChatQuestion.value || '').trim();
            if (!rawQuestion) {
                tableChatResponse.classList.add('error');
                tableChatResponse.textContent = 'è¯·è¾“å…¥éœ€è¦åˆ†æçš„é—®é¢˜ã€‚';
                return;
            }

            const processContext = resolveProcessContext(rawQuestion);
            if (!processContext.success && !(tableChatSkipValidation && tableChatSkipValidation.checked)) {
                tableChatResponse.classList.add('error');
                if (processContext.reason === 'missing_keyword') {
                    tableChatResponse.textContent = 'è¯·åœ¨æé—®ä¸­æ˜ç¡®å·¥åºåç§°ï¼Œä¾‹å¦‚ï¼šæº¶å‡ºã€æ²‰é™ã€ç……çƒ§ç­‰ã€‚';
                } else if (processContext.reason === 'no_columns') {
                    const hints = processContext.matches?.length ? `è¯†åˆ«åˆ°å…³é”®è¯ï¼š${processContext.matches.join('ï¼Œ')}ï¼Œ` : '';
                    tableChatResponse.textContent = `${hints}ä½†æœªåœ¨å½“å‰æ•°æ®ä¸­å‘ç°ä¸"${processContext.process}"ç›¸å…³çš„å­—æ®µï¼Œè¯·ç¡®è®¤è¡¨æ ¼æ˜¯å¦åŒ…å«è¯¥å·¥åºæˆ–å°è¯•å…¶ä»–å…³é”®è¯ã€‚`;
                } else {
                    tableChatResponse.textContent = 'æ— æ³•è¯†åˆ«æé—®ä¸Šä¸‹æ–‡ï¼Œè¯·é‡æ–°è¡¨è¿°é—®é¢˜ã€‚';
                }
                return;
            }

            tableChatResponse.classList.remove('empty-state', 'error');
            tableChatResponse.textContent = 'è¡¨æ ¼AIæ­£åœ¨åˆ†æï¼Œè¯·ç¨å€™...';
            chatState.draft = rawQuestion;
            tableChatSendBtn.dataset.originalLabel = tableChatSendBtn.textContent;
            tableChatSendBtn.disabled = true;
            tableChatSendBtn.textContent = 'åˆ†æä¸­...';

            const provider = tableChatProviderSelect.value;
            const historyPayload = isLocalProvider(provider) ? tableChatHistory : [];
            const focusFromSelect = tableChatFocusSelect
                ? Array.from(tableChatFocusSelect.selectedOptions).map((opt) => opt.value)
                : [];
            const focusColumns = Array.from(new Set([
                ...focusFromSelect,
                ...(processContext.success ? processContext.columns.slice(0, 8) : []),
            ]));

            try {
                const response = await fetch('/table-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider,
                        question: processContext.success ? processContext.enrichedQuestion : rawQuestion,
                        cache_key: tableChatActiveCacheKey,
                        history: historyPayload,
                        focus_columns: focusColumns,
                    }),
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    tableChatResponse.classList.add('error');
                    const errorText = data.detail || data.error || 'è¡¨æ ¼å¯¹è¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                    tableChatResponse.textContent = errorText;
                    tableChatQuotaInfo.textContent = formatQuotaText(data);
                    chatState.responseHTML = `<p class="error">${errorText}</p>`;
                    chatState.quotaText = tableChatQuotaInfo.textContent;
                    return;
                }
                if (isLocalProvider(provider)) {
                    chatState.history = chatState.history || [];
                    chatState.history.push({ role: 'user', content: rawQuestion });
                    chatState.history.push({ role: 'assistant', content: data.answer || '' });
                    tableChatHistory = chatState.history;
                    chatState.quotaText = '';
                    chatState.draft = '';
                    tableChatQuestion.value = '';
                    renderTableChatOutput();
                } else {
                    tableChatResponse.classList.remove('error');
                    const renderedAnswer = renderAnswerHtml(data.answer || 'åˆ†æå®Œæˆï¼Œä½†æœªç”Ÿæˆæœ‰æ•ˆç­”æ¡ˆã€‚');
                    const quotaText = formatQuotaText(data);
                    tableChatResponse.innerHTML = renderedAnswer;
                    tableChatQuotaInfo.textContent = quotaText;
                    chatState.responseHTML = renderedAnswer;
                    chatState.quotaText = quotaText;
                    chatState.draft = '';
                    tableChatQuestion.value = '';
                }
            } catch (err) {
                tableChatResponse.classList.add('error');
                const errorText = `è¯·æ±‚å¤±è´¥ï¼š${err}`;
                tableChatResponse.textContent = errorText;
                tableChatQuotaInfo.textContent = '';
                chatState.responseHTML = `<p class="error">${errorText}</p>`;
                chatState.quotaText = '';
            }
            tableChatSendBtn.disabled = false;
            const originalLabel = tableChatSendBtn.dataset.originalLabel || 'åˆ†æ';
            tableChatSendBtn.textContent = originalLabel;
            delete tableChatSendBtn.dataset.originalLabel;
            persistTableChatState();
        });

        function renderTableChatOutput() {
            const provider = tableChatProviderSelect.value;
            const chatState = getTableChatStateForCache(tableChatActiveCacheKey || tableCacheKey);
            if (isLocalProvider(provider)) {
                if (chatState.history && chatState.history.length) {
                    tableChatResponse.classList.remove('empty-state', 'error');
                    tableChatResponse.innerHTML = renderChatTranscript(chatState.history);
                } else {
                    tableChatResponse.classList.add('empty-state');
                    tableChatResponse.textContent = 'æœªå¼€å§‹å¯¹è¯ï¼Œè¯·è¾“å…¥é—®é¢˜å¹¶ç‚¹å‡»"åˆ†æ"ã€‚';
                }
                tableChatQuotaInfo.textContent = '';
            } else {
                if (chatState.responseHTML) {
                    tableChatResponse.classList.remove('empty-state', 'error');
                    tableChatResponse.innerHTML = chatState.responseHTML;
                } else {
                    tableChatResponse.classList.add('empty-state');
                    tableChatResponse.textContent = 'å‡†å¤‡å°±ç»ªï¼Œè¯·è¾“å…¥é—®é¢˜åç‚¹å‡»"åˆ†æ"ã€‚';
                }
                tableChatQuotaInfo.textContent = chatState.quotaText || '';
            }
            tableChatQuestion.value = chatState.draft || '';
        }

        function renderChatTranscript(history) {
            const parts = history.map((entry) => {
                const roleLabel = entry.role === 'user' ? 'ç”¨æˆ·' : 'æ™ºèƒ½ä½“';
                const content = renderAnswerHtml(entry.content || '');
                const roleClass = entry.role === 'user' ? 'user' : 'assistant';
                return `
                    <div class="chat-message ${roleClass}">
                        <div class="chat-role">${roleLabel}</div>
                        <div class="chat-content">${content}</div>
                    </div>
                `;
            });
            return `<div class="chat-transcript">${parts.join('')}</div>`;
        }

        function persistTableChatState() {
            const activeKey = tableChatActiveCacheKey || tableCacheKey;
            if (!activeKey) {
                return;
            }
            const chatState = getTableChatStateForCache(activeKey);
            chatState.responseHTML = tableChatResponse.innerHTML;
            chatState.quotaText = tableChatQuotaInfo.textContent;
            chatState.draft = tableChatQuestion.value;
            chatState.history = [...tableChatHistory];
        }

        const providerStatusBar = document.getElementById('provider-status-bar');
        let statusIntervalId = null;

        async function refreshProviderStatus() {
            const statusItems = Array.from(providerStatusBar.querySelectorAll('.status-item'));
            const updateStatus = (provider, state, message) => {
                const item = statusItems.find((el) => el.dataset.provider === provider);
                if (!item) return;
                item.dataset.state = state;
                item.title = message || '';
            };

            statusItems.forEach((item) => updateStatus(item.dataset.provider, 'checking', 'æ£€æµ‹ä¸­â€¦'));

            updateStatus('bailian', 'online', 'äº‘ç«¯æ¨¡å‹');

            try {
                const resp = await fetch('/status/ollama');
                const data = await resp.json();
                if (resp.ok && data.success) {
                    updateStatus('ollama', 'online', 'æœ¬åœ° Ollama æ­£å¸¸');
                } else {
                    updateStatus('ollama', 'offline', data.error || 'æœªæ£€æµ‹åˆ° Ollama æœåŠ¡');
                }
            } catch (err) {
                updateStatus('ollama', 'offline', String(err));
            }

            const tablegptBase = tableChatProviderSelect.dataset.tablegptBase || '';
            if (!tablegptBase) {
                updateStatus('tablegpt', 'warning', 'æœªé…ç½® TableGPT åœ°å€');
            } else {
                try {
                    const resp = await fetch(`/status/tablegpt?base_url=${encodeURIComponent(tablegptBase)}`);
                    const data = await resp.json();
                    if (resp.ok && data.success) {
                        updateStatus('tablegpt', 'online', 'TableGPT æœ¬åœ°æœåŠ¡æ­£å¸¸');
                    } else {
                        updateStatus('tablegpt', 'offline', data.error || 'æ— æ³•è¿æ¥ TableGPT');
                        console.warn('TableGPT çŠ¶æ€æ£€æµ‹å¤±è´¥:', data.error);
                    }
                } catch (err) {
                    updateStatus('tablegpt', 'offline', String(err));
                    console.warn('TableGPT çŠ¶æ€è¯·æ±‚å¼‚å¸¸:', err);
                }
            }
        }

        refreshProviderStatus();
        statusIntervalId = setInterval(refreshProviderStatus, 10000);


        reportEditor?.addEventListener('input', () => {
            reportState.draft = reportEditor.value;
            if (reportExportBtn) {
                reportExportBtn.disabled = !reportEditor.value.trim();
            }
        });

        openReportBtn?.addEventListener('click', async () => {
            persistReportState();
            if (!reportState.content && !reportGenerating) {
                await generateReport();
            }
            applyReportStateToUI();
            reportModal?.classList.remove('hidden');
        });

        closeReportBtn?.addEventListener('click', () => {
            persistReportState();
            reportModal?.classList.add('hidden');
        });

        reportModal?.addEventListener('click', (event) => {
            if (event.target === reportModal || event.target.classList.contains('report-modal-backdrop')) {
                persistReportState();
                reportModal.classList.add('hidden');
            }
        });

        reportExportBtn?.addEventListener('click', () => {
            const content = (reportEditor?.value || reportState.content || '').trim();
            if (!content) {
                setReportMessage('æ— å¯å¯¼å‡ºçš„å†…å®¹ï¼Œè¯·å…ˆç”ŸæˆæŠ¥è¡¨ã€‚', 'error');
                return;
            }

            const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const ts = reportState.generatedAt ? reportState.generatedAt.replace(/[:T]/g, '-').split('.')[0] : 'report';
            link.href = url;
            link.download = `æŒ‡æ ‡åˆ†ææŠ¥è¡¨-${ts}.md`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });

        exportExcelBtn?.addEventListener('click', async () => {
            if (!tableCacheKey) {
                alert('è¯·å…ˆä¸Šä¼ å¹¶é¢„è§ˆæ•°æ®');
                return;
            }

            const selectedColumns = Array.from(columnsSelect.selectedOptions).map((opt) => opt.value);
            if (!selectedColumns.length) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæŒ‡æ ‡å­—æ®µ');
                return;
            }

            const timestampColumn = timestampSelect.value || null;

            try {
                exportExcelBtn.disabled = true;
                exportExcelBtn.textContent = 'å¯¼å‡ºä¸­...';

                const response = await fetch('/report/export/excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cache_key: tableCacheKey,
                        columns: selectedColumns,
                        timestamp_column: timestampColumn,
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Excel å¯¼å‡ºå¤±è´¥');
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const filename = response.headers.get('Content-Disposition')?.match(/filename="(.+)"/)?.[1] || 'æ‹œè€³æ³•åˆ†ææŠ¥å‘Š.xlsx';
                link.href = url;
                link.download = decodeURIComponent(filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (err) {
                alert(`Excel å¯¼å‡ºå¤±è´¥: ${err.message}`);
            } finally {
                exportExcelBtn.disabled = false;
                exportExcelBtn.textContent = 'å¯¼å‡ºExcel';
            }
        });

        function populateTableChatFocus(numericColumns) {
            if (!tableChatFocusSelect) return;
            tableChatFocusSelect.innerHTML = '';
            numericColumns.forEach((column) => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                tableChatFocusSelect.appendChild(option);
            });
        }
    </script>
</body>
</html>
</html>